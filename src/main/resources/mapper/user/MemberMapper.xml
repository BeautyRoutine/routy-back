<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.routy.routyback.mapper.user.MemberMapper">

  <!-- 공용 컬럼 별칭: DB 컬럼 -> DTO 필드 오류뜨면 수정할게요 !  -->
  <sql id="memberColumns">
    USERNO         AS userNo,
    USERID         AS userId,
    USEREMAIL      AS userEmail,
    USERNICK       AS userNick,
    USERPW         AS userPw,
    USERNAME       AS userName,
    USERHP         AS userHp,
    USERAUTH       AS userAuth,
    USERCI         AS userCi,
    USERZIP        AS userZip,
    USERJIBUNADDR  AS userJibunAddr,
    USERROADADDR   AS userRoadAddr,
    USERDETAILADDR AS userDetailAddr,
    USERBCODE      AS userBcode,
    USERSKIN       AS userSkin,
    USERCOLOR      AS userColor,
    USERLEVEL      AS userLevel,
    USERSTATUS     AS userStatus,
    USERBIRTH      AS userBirth,
    USERUPDATE     AS userUpdate,
    USERREGDATE    AS userRegdate
  </sql>

  <!-- 회원가입: PK(USERNO)와 날짜 2개는 DB 기본값(CURRENT_TIMESTAMP/시퀀스) 사용 변경되면 수정할게요 -->
  <insert id="insertMember" parameterType="com.routy.routyback.dto.MemberDTO">
    INSERT INTO USERS (
      USERID, USEREMAIL, USERNICK, USERPW, USERNAME, USERHP,
      USERAUTH, USERCI, USERZIP, USERJIBUNADDR, USERROADADDR, USERDETAILADDR,
      USERBCODE, USERSKIN, USERCOLOR, USERLEVEL, USERSTATUS, USERBIRTH
    ) VALUES (
      #{userId}, #{userEmail}, #{userNick}, #{userPw}, #{userName}, #{userHp},
      #{userAuth}, #{userCi}, #{userZip}, #{userJibunAddr}, #{userRoadAddr}, #{userDetailAddr},
      #{userBcode}, #{userSkin}, #{userColor}, #{userLevel}, #{userStatus}, #{userBirth}
    )
  </insert>

  <!-- 이메일로 단건 -->
  <select id="findByEmail" resultType="com.routy.routyback.dto.MemberDTO">
    SELECT
      <include refid="memberColumns"/>
    FROM USERS
    WHERE USEREMAIL = #{email}
  </select>

  <!-- PK로 단건 -->
  <select id="findById" resultType="com.routy.routyback.dto.MemberDTO">
    SELECT
      <include refid="memberColumns"/>
    FROM USERS
    WHERE USERNO = #{id}
  </select>

  <!-- 목록 + 검색 + 페이지네이션 (Oracle 12c+: OFFSET/FETCH) -->
  <select id="findAll" resultType="com.routy.routyback.dto.MemberDTO">
    SELECT
      <include refid="memberColumns"/>
    FROM USERS
    <where>
      <if test="type != null and type != '' and keyword != null and keyword != ''">
        <choose>
          <when test="type == 'id'">       USERID    LIKE '%' || #{keyword} || '%'</when>
          <when test="type == 'email'">    USEREMAIL LIKE '%' || #{keyword} || '%'</when>
          <when test="type == 'nick'">     USERNICK  LIKE '%' || #{keyword} || '%'</when>
          <otherwise>                      USERNAME  LIKE '%' || #{keyword} || '%'</otherwise>
        </choose>
      </if>
    </where>
    ORDER BY USERNO DESC
    OFFSET #{offset} ROWS FETCH NEXT #{limit} ROWS ONLY
  </select>

  <!-- 총 개수 -->
  <select id="countAll" resultType="int">
    SELECT COUNT(1)
    FROM USERS
    <where>
      <if test="type != null and type != '' and keyword != null and keyword != ''">
        <choose>
          <when test="type == 'id'">       USERID    LIKE '%' || #{keyword} || '%'</when>
          <when test="type == 'email'">    USEREMAIL LIKE '%' || #{keyword} || '%'</when>
          <when test="type == 'nick'">     USERNICK  LIKE '%' || #{keyword} || '%'</when>
          <otherwise>                      USERNAME  LIKE '%' || #{keyword} || '%'</otherwise>
        </choose>
      </if>
    </where>
  </select>

</mapper>
