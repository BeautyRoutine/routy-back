<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.routy.routyback.mapper.user.ProductRecentRecommendMapper">

    <!-- 1) 가장 최근 본 상품의 소카테고리 -->
    <select id="findLatestSubcate" resultType="int">
        SELECT PRDSUBCATE
        FROM VIEWED_PRODUCT
        WHERE USERNO = #{userNo}
        ORDER BY VPREGDATE DESC
            FETCH FIRST 1 ROW ONLY
    </select>

    <!-- 2) 추천 상품 조회 -->
    <select id="recommendByLatestSubcate"
            resultType="com.routy.routyback.dto.ProductRecentRecommendDTO">

        SELECT
        P.PRDNO AS prdNo,
        P.PRDNAME AS prdName,
        P.PRDCOMPANY AS prdCompany,
        P.PRDIMG AS prdImg
        FROM PRODUCT P
        WHERE 1 = 1
        AND P.PRDSUBCATE = #{subcate}

        <!-- 기피·알러지 성분이 포함된 상품 제외 -->
        AND NOT EXISTS (
        SELECT 1
        FROM PIMAP PI
        JOIN UIMAP UI ON UI.INGNO = PI.INGNO
        WHERE PI.PRDNO = P.PRDNO
        AND UI.USERNO = #{userNo}
        AND UI.UIMAPTYPE IN (2,3)
        )

        ORDER BY
        P.REVIEWCOUNT DESC,
        P.AVGRATING DESC

        FETCH FIRST 4 ROWS ONLY

    </select>

</mapper>
