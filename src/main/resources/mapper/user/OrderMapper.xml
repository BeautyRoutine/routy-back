<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    주문 관련 Mapper XML
    주문 상태 요약 / 주문 목록 / 주문 상세 / 주문상품 목록
    모든 주문 기능 SQL을 단일 XML로 통합 관리합니다.
    @author 김지용
-->
<mapper namespace="com.routy.routyback.mapper.order.OrderMapper">

    <!-- 1) 주문 상태 요약 -->
    <select id="getOrderStatusSummary"
        parameterType="string"
        resultType="com.routy.routyback.dto.order.OrderStatusSummaryResponse">
        SELECT COUNT(DECODE(ODSTATUS, 2, 1)) AS paymentComplete,
               COUNT(DECODE(ODSTATUS, 3, 1)) AS preparing,
               COUNT(DECODE(ODSTATUS, 4, 1)) AS shipping,
               COUNT(DECODE(ODSTATUS, 5, 1)) AS delivered,
               COUNT(DECODE(ODSTATUS, 6, 1)) AS canceled,
               COUNT(DECODE(ODSTATUS, 7, 1)) AS returned,
               COUNT(DECODE(ODSTATUS, 8, 1)) AS exchanged
        FROM ORDERS o
        	INNER JOIN USERS u ON u.userNo=o.userNo
        WHERE u.userId= #{userId}
    </select>

    <!-- 2) 주문 목록 조회 -->
    <select id="getOrderList"
        parameterType="string"
        resultType="com.routy.routyback.dto.order.OrderListItemResponse">
        SELECT O.ODNO												AS orderNo,
        	   P.PRDNO												AS productNo,
               P.PRDNAME											AS productName,
               P.PRDIMG												AS productImage,
               PM.PPMAPNO											AS ppMapNo,
               PM.PPMAPSTOCK										AS prodcutStock,
               PM.PPMAPPRICE										AS productPrice,
               (SELECT COUNT(*)
               FROM REVIEW R
               WHERE R.PRDNO=PM.PRDNO AND R.USERNO=U.USERNO)		AS reviewCnt,
               (SELECT COUNT(*)
               FROM QNA QA
               WHERE QA.ODNO=O.ODNO AND QA.USERNO=U.USERNO
                     AND QA.QNATYPE=5 AND QA.QNASTATUS IN (1, 2))	AS returnCnt,
               (SELECT COUNT(*)
               FROM QNA QA
               WHERE QA.ODNO=O.ODNO AND QA.USERNO=U.USERNO
                     AND QA.QNATYPE=6 AND QA.QNASTATUS IN (1, 2))	AS swapCnt,
               TO_CHAR(O.ODREGDATE, 'YYYY-MM-DD')					AS orderDate,
               O.ODSTATUS											AS orderStatus
               
        FROM ORDERS O
             INNER JOIN PAY_PRODUCT_MAPPING PM ON PM.ODNO = O.ODNO
             INNER JOIN PRODUCT P ON P.PRDNO = PM.PRDNO
             INNER JOIN USERS U ON U.userNo=O.userNo
        WHERE U.USERID = #{userId} AND O.ODSTATUS > 1
        ORDER BY orderNo DESC, ppMapNo ASC
    </select>

    <!-- 3) 주문 상세 조회 -->
    <select id="getOrderDetail"
        parameterType="long"
        resultType="com.routy.routyback.dto.order.OrderDetailResponse">
        SELECT O.ODNO                                        AS orderNo,
               TO_CHAR(O.ODREGDATE, 'YYYY-MM-DD HH24:MI:SS') AS orderDate,
               O.ODSTATUS                                    AS orderStatus,
               (O.ODPRDPRICE + O.ODDELVPRICE)                AS totalPrice,
               O.ODDELVPRICE                                 AS deliveryPrice
        FROM ORDERS O
        WHERE O.ODNO = #{odNo}
    </select>

    <!-- 3-1) 주문 상세 상품 목록 -->
    <select id="getOrderItems"
        parameterType="long"
        resultType="com.routy.routyback.dto.order.OrderDetailResponse$OrderItem">
        SELECT P.PRDNO                         AS productNo,
               P.PRDNAME                       AS productName,
               P.PRDIMG                        AS productImage,
               PM.PPMAPSTOCK                   AS quantity,
               PM.PPMAPPRICE                   AS price,
               (PM.PPMAPSTOCK * PM.PPMAPPRICE) AS total
        FROM PAY_PRODUCT_MAPPING PM
                 JOIN PRODUCT P ON P.PRDNO = PM.PRDNO
        WHERE PM.ODNO = #{odNo}
    </select>

</mapper>