<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.routy.routyback.mapper.user.RecommendedProductMapper">
    <!-- 1. 비로그인: 전체 평점 상위 -->
    <select id="recommendByRating"
            resultType="com.routy.routyback.dto.RecommendedProductDTO">
        SELECT
        p.PRDNO AS prdNo,
        p.PRDNAME AS prdName,
        p.PRDCOMPANY AS prdCompany,
        p.PRDIMG AS prdImg,
        ROUND(AVG(r.REVSTAR), 2) AS avgRating,
        COUNT(r.REVNO) AS reviewCount
        FROM PRODUCT p
        LEFT JOIN REVIEW r ON p.PRDNO = r.PRDNO
        GROUP BY p.PRDNO, p.PRDNAME, p.PRDCOMPANY, p.PRDIMG
        ORDER BY avgRating DESC NULLS LAST, reviewCount DESC NULLS LAST
        FETCH FIRST #{limit} ROWS ONLY
    </select>

    <!-- 2. 특정 카테고리에서 평점 상위 1개 -->
    <select id="recommendByCategory"
            resultType="com.routy.routyback.dto.RecommendedProductDTO">
        SELECT
        p.PRDNO AS prdNo,
        p.PRDNAME AS prdName,
        p.PRDCOMPANY AS prdCompany,
        p.PRDIMG AS prdImg,
        ROUND(AVG(r.REVSTAR), 2) AS avgRating,
        COUNT(r.REVNO) AS reviewCount
        FROM PRODUCT p
        LEFT JOIN REVIEW r ON p.PRDNO = r.PRDNO
        WHERE p.PRDMAINCATE = #{cate}
        GROUP BY p.PRDNO, p.PRDNAME, p.PRDCOMPANY, p.PRDIMG
        ORDER BY avgRating DESC NULLS LAST, reviewCount DESC NULLS LAST
        FETCH FIRST 1 ROW ONLY
    </select>

    <!-- 3. 최근 본 상품들의 카테고리 리스트 추출 -->
    <select id="getCategories"
            parameterType="list"
            resultType="string">
        SELECT DISTINCT PRDMAINCATE
        FROM PRODUCT
        WHERE PRDNO IN
        <foreach collection="list" item="prd" open="(" close=")" separator=",">
            #{prd}
        </foreach>
    </select>

</mapper>
